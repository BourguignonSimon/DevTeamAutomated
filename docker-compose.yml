services:
  redis:
    image: redis:7-alpine
    container_name: audit_redis
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 1s
      retries: 30

  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: audit_orchestrator
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: orchestrator
      CONSUMER_NAME: orchestrator-1
      LOCK_TTL_S: 300
      IDEMPOTENCE_TTL_S: 604800
    depends_on:
      redis:
        condition: service_healthy

  validator:
    build:
      context: .
      dockerfile: services/stream_consumer/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: validators
      CONSUMER_NAME: validator-1
    depends_on:
      redis:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: services/worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: workers
      CONSUMER_NAME: worker-1
    depends_on:
      redis:
        condition: service_healthy

  time_waste_worker:
    build:
      context: .
      dockerfile: services/time_waste_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: time_waste_workers
      CONSUMER_NAME: time-waste-1
    depends_on:
      redis:
        condition: service_healthy

  cost_worker:
    build:
      context: .
      dockerfile: services/cost_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: cost_workers
      CONSUMER_NAME: cost-1
    depends_on:
      redis:
        condition: service_healthy

  friction_worker:
    build:
      context: .
      dockerfile: services/friction_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: friction_workers
      CONSUMER_NAME: friction-1
    depends_on:
      redis:
        condition: service_healthy

  scenario_worker:
    build:
      context: .
      dockerfile: services/scenario_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: scenario_workers
      CONSUMER_NAME: scenario-1
    depends_on:
      redis:
        condition: service_healthy

  requirements_manager_worker:
    build:
      context: .
      dockerfile: services/requirements_manager_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: requirements_manager_workers
      CONSUMER_NAME: requirements-manager-1
    depends_on:
      redis:
        condition: service_healthy

  dev_worker:
    build:
      context: .
      dockerfile: services/dev_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: dev_workers
      CONSUMER_NAME: dev-worker-1
    depends_on:
      redis:
        condition: service_healthy

  test_worker:
    build:
      context: .
      dockerfile: services/test_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: test_workers
      CONSUMER_NAME: test-worker-1
    depends_on:
      redis:
        condition: service_healthy

  order_intake_agent:
    build:
      context: .
      dockerfile: services/order_intake_agent/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: order_intake
      CONSUMER_NAME: order-intake-1
      STORAGE_DIR: /storage
      LLM_GATEWAY_URL: http://llm_gateway:8000
      LLM_PROVIDER_ORDER: anthropic,openai,gemini
    volumes:
      - ./storage:/storage
    ports:
      - "8080:8080"
    depends_on:
      redis:
        condition: service_healthy
      llm_gateway:
        condition: service_started

  llm_gateway:
    build:
      context: .
      dockerfile: services/llm_gateway/Dockerfile
    environment:
      LOG_LEVEL: INFO
      LLM_PROVIDER_ORDER: anthropic,openai,gemini
      LLM_TEST_MODE: "true"
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_healthy

  web_gateway:
    build:
      context: .
      dockerfile: services/web_gateway/Dockerfile
    container_name: audit_web_gateway
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      KEY_PREFIX: audit
      NAMESPACE: audit
      LOG_LEVEL: INFO
      WEB_GATEWAY_PORT: 3000
    ports:
      - "3000:3000"
    depends_on:
      redis:
        condition: service_healthy
      orchestrator:
        condition: service_started

  tests:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: audit_tests
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      LOCK_TTL_S: 300
      IDEMPOTENCE_TTL_S: 604800
    depends_on:
      redis:
        condition: service_healthy
      orchestrator:
        condition: service_started
    command: ["pytest", "-q"]
