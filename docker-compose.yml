services:
  redis:
    image: redis:7-alpine
    container_name: audit_redis
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 1s
      retries: 30

  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: audit_orchestrator
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: orchestrator
      CONSUMER_NAME: orchestrator-1
      LOCK_TTL_S: 300
      IDEMPOTENCE_TTL_S: 604800
    depends_on:
      redis:
        condition: service_healthy

  validator:
    build:
      context: .
      dockerfile: services/stream_consumer/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: validators
      CONSUMER_NAME: validator-1
    depends_on:
      redis:
        condition: service_healthy

  worker:
    build:
      context: .
      dockerfile: services/worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: workers
      CONSUMER_NAME: worker-1
    depends_on:
      redis:
        condition: service_healthy

  time_waste_worker:
    build:
      context: .
      dockerfile: services/time_waste_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: time_waste_workers
      CONSUMER_NAME: time-waste-1
    depends_on:
      redis:
        condition: service_healthy

  cost_worker:
    build:
      context: .
      dockerfile: services/cost_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: cost_workers
      CONSUMER_NAME: cost-1
    depends_on:
      redis:
        condition: service_healthy

  friction_worker:
    build:
      context: .
      dockerfile: services/friction_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: friction_workers
      CONSUMER_NAME: friction-1
    depends_on:
      redis:
        condition: service_healthy

  scenario_worker:
    build:
      context: .
      dockerfile: services/scenario_worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: scenario_workers
      CONSUMER_NAME: scenario-1
    depends_on:
      redis:
        condition: service_healthy

  order_intake_agent:
    build:
      context: .
      dockerfile: services/order_intake_agent/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      CONSUMER_GROUP: order_intake
      CONSUMER_NAME: order-intake-1
      STORAGE_DIR: /storage
    volumes:
      - ./storage:/storage
    ports:
      - "8080:8080"
    depends_on:
      redis:
        condition: service_healthy

  tests:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: audit_tests
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STREAM_NAME: audit:events
      DLQ_STREAM: audit:dlq
      LOCK_TTL_S: 300
      IDEMPOTENCE_TTL_S: 604800
    depends_on:
      redis:
        condition: service_healthy
      orchestrator:
        condition: service_started
    command: ["pytest", "-q"]
